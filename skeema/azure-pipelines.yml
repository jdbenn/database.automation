name: $(Year:yyyy).$(Month).$(DayOfMonth)$(Rev:.r)

variables:

  - name: projectDirectory
    value: $(System.DefaultWorkingDirectory)/skeema
  - name: region
    value: us-east-1
  - name: DbHost
  - name: DbPort
  - name: DbUser
  - name: DbPassword

stages:
  - stage: deployDatabase
    condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))
    displayName: Deploy Database Changes
    jobs:
      - job: skeema
        displayName: Run Skeema Diff and Deploy
        workspace:
          clean: all
        steps:
          - task: AWSShellScript@1
            displayName: Update Pipeline Variables
            inputs:
              awsCredentials: "SPR"
              regionName: "$(region)"
              scriptType: "inline"
              inlineScript: |
                host=`aws ssm get-parameter --name db-automation-mysql-host --region $(region) --query "Parameter.Value" --output text`
                port=`aws ssm get-parameter --name db-automation-mysql-port --region $(region) --query "Parameter.Value" --output text`
                user=`aws ssm get-parameter --name db-automation-mysql-user --region $(region) --query "Parameter.Value" --output text`
                password=`aws ssm get-parameter --name db-automation-mysql-password --region $(region) --query "Parameter.Value" --output text`

                echo "##vso[task.setvariable variable=DbHost;]$host"
                echo "##vso[task.setvariable variable=DbPort;]$port"
                echo "##vso[task.setvariable variable=DbUser;]$user"
                echo "##vso[task.setvariable variable=DbPassword;]$password"

          - task: qetza.replacetokens.replacetokens-task.replacetokens@3
            displayName: Update .skeema Deploy Config
            inputs:
              targetFiles: |
                $(projectDirectory)/schemas/.skeema

          - task: Bash@3
            displayName: Deploy Skeema Changes
            inputs:
              targetType: 'inline'
              script: |
                skeema diff deploy --allow-unsafe
                skeema push deploy --allow-unsafe
              workingDirectory: '$(projectDirectory)/schemas'
